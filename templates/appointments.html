{% extends "base.html" %}

{% block content %}
<!-- FILTER CONTROL PANEL -->
<div class="card shadow mb-4">
    <div class="card-body bg-light">
        <form method="GET" action="/appointments" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-bold">üìÖ Time Period</label>
                <select name="period" class="form-select">
                    <option value="day" {% if selected_period == 'day' %}selected{% endif %}>Daily View</option>
                    <option value="month" {% if selected_period == 'month' %}selected{% endif %}>Monthly View</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">üë§ Filter by Technician</label>
                <select name="tech_id" class="form-select">
                    <option value="all">All Staff</option>
                    {% for t in all_techs %}
                        <option value="{{ t.id }}" {% if selected_tech == t.id|string %}selected{% endif %}>{{ t.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary w-100">üîÑ Update Charts</button>
            </div>
        </form>
    </div>
</div>

<!-- CHARTS ROW 1: MAIN TREND -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-white">
                <h5 class="mb-0">üìà Revenue Trend ({{ selected_period|title }})</h5>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- CHARTS ROW 2: BREAKDOWNS -->
<div class="row mb-4">
    <!-- Tech Breakdown -->
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">‚úÇÔ∏è Revenue by Technician</h5>
            </div>
            <div class="card-body">
                <canvas id="techChart"></canvas>
            </div>
        </div>
    </div>
    <!-- Service Breakdown -->
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">üíÖ Revenue by Service Type</h5>
            </div>
            <div class="card-body">
                <!-- Constrain height for pie charts -->
                <div style="max-height: 300px; display: flex; justify-content: center;">
                    <canvas id="serviceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DATA TABLE -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">üìù Detailed Appointment Log</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Service</th>
                                <th>Technician</th>
                                <th>Price</th>
                                <th>Tip</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for appt in history %}
                            <tr>
                                <td>{{ appt.date_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td class="fw-bold">{{ appt.customer.first_name }}</td>
                                <td>{{ appt.service.name }}</td>
                                <td>{{ appt.technician.name }}</td>
                                <td>${{ "%.2f"|format(appt.price_charged) }}</td>
                                <td class="text-success">+${{ "%.2f"|format(appt.tip_amount) }}</td>
                                <td class="fw-bold">${{ "%.2f"|format(appt.price_charged + appt.tip_amount) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CHART.JS LOGIC -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Parse Data from Python into JavaScript variables first
    // This prevents syntax errors if data is missing and makes debugging easier
    const trendLabels = {{ trend_labels | tojson | safe }};
    const trendValues = {{ trend_values | tojson | safe }};

    const techLabels = {{ tech_labels | tojson | safe }};
    const techValues = {{ tech_values | tojson | safe }};

    const serviceLabels = {{ service_labels | tojson | safe }};
    const serviceValues = {{ service_values | tojson | safe }};

    // 1. TREND CHART (Line)
    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: trendLabels,
            datasets: [{
                label: 'Total Revenue ($)',
                data: trendValues,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });

    // 2. TECH CHART (Bar)
    new Chart(document.getElementById('techChart'), {
        type: 'bar',
        data: {
            labels: techLabels,
            datasets: [{
                label: 'Revenue ($)',
                data: techValues,
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });

    // 3. SERVICE CHART (Doughnut)
    new Chart(document.getElementById('serviceChart'), {
        type: 'doughnut',
        data: {
            labels: serviceLabels,
            datasets: [{
                data: serviceValues,
                backgroundColor: ['#4BC0C0', '#FF9F40', '#FF6384', '#36A2EB']
            }]
        }
    });
</script>
{% endblock %}
